<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/client.js - node-upwork</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="https://developers.upwork.com/_static/img/logo-white.png" title="node-upwork"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Accounts.html">Accounts</a></li>
                                <li><a href="../classes/Applications.html">Applications</a></li>
                                <li><a href="../classes/Auth.html">Auth</a></li>
                                <li><a href="../classes/Billings.html">Billings</a></li>
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/Companies.html">Companies</a></li>
                                <li><a href="../classes/Config.html">Config</a></li>
                                <li><a href="../classes/Debug.html">Debug</a></li>
                                <li><a href="../classes/Earnings.html">Earnings</a></li>
                                <li><a href="../classes/Engagement.html">Engagement</a></li>
                                <li><a href="../classes/Engagements.html">Engagements</a></li>
                                <li><a href="../classes/Graphql.html">Graphql</a></li>
                                <li><a href="../classes/Interviews.html">Interviews</a></li>
                                <li><a href="../classes/Jobs.html">Jobs</a></li>
                                <li><a href="../classes/Messages.html">Messages</a></li>
                                <li><a href="../classes/Metadata.html">Metadata</a></li>
                                <li><a href="../classes/Offers.html">Offers</a></li>
                                <li><a href="../classes/Payments.html">Payments</a></li>
                                <li><a href="../classes/Profile.html">Profile</a></li>
                                <li><a href="../classes/Roles.html">Roles</a></li>
                                <li><a href="../classes/Search.html">Search</a></li>
                                <li><a href="../classes/Snapshot.html">Snapshot</a></li>
                                <li><a href="../classes/Team.html">Team</a></li>
                                <li><a href="../classes/Teams.html">Teams</a></li>
                                <li><a href="../classes/Time.html">Time</a></li>
                                <li><a href="../classes/UpworkApi.html">UpworkApi</a></li>
                                <li><a href="../classes/Users.html">Users</a></li>
                                <li><a href="../classes/Workdays.html">Workdays</a></li>
                                <li><a href="../classes/Workdiary.html">Workdiary</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/api.html">api</a></li>
                                <li><a href="../modules/client.html">client</a></li>
                                <li><a href="../modules/config.html">config</a></li>
                                <li><a href="../modules/debug.html">debug</a></li>
                                <li><a href="../modules/routes.activities.engagement.html">routes.activities.engagement</a></li>
                                <li><a href="../modules/routes.activities.team.html">routes.activities.team</a></li>
                                <li><a href="../modules/routes.auth.html">routes.auth</a></li>
                                <li><a href="../modules/routes.freelancers.profile.html">routes.freelancers.profile</a></li>
                                <li><a href="../modules/routes.freelancers.search.html">routes.freelancers.search</a></li>
                                <li><a href="../modules/routes.graphql.html">routes.graphql</a></li>
                                <li><a href="../modules/routes.hr.clients.applications.html">routes.hr.clients.applications</a></li>
                                <li><a href="../modules/routes.hr.clients.offers.html">routes.hr.clients.offers</a></li>
                                <li><a href="../modules/routes.hr.contractors.applications.html">routes.hr.contractors.applications</a></li>
                                <li><a href="../modules/routes.hr.contractors.offers.html">routes.hr.contractors.offers</a></li>
                                <li><a href="../modules/routes.hr.contracts.html">routes.hr.contracts</a></li>
                                <li><a href="../modules/routes.hr.engagements.html">routes.hr.engagements</a></li>
                                <li><a href="../modules/routes.hr.interviews.html">routes.hr.interviews</a></li>
                                <li><a href="../modules/routes.hr.jobs.html">routes.hr.jobs</a></li>
                                <li><a href="../modules/routes.hr.milestones.html">routes.hr.milestones</a></li>
                                <li><a href="../modules/routes.hr.roles.html">routes.hr.roles</a></li>
                                <li><a href="../modules/routes.hr.submissions.html">routes.hr.submissions</a></li>
                                <li><a href="../modules/routes.jobs.profile.html">routes.jobs.profile</a></li>
                                <li><a href="../modules/routes.jobs.search.html">routes.jobs.search</a></li>
                                <li><a href="../modules/routes.messages.html">routes.messages</a></li>
                                <li><a href="../modules/routes.metadata.html">routes.metadata</a></li>
                                <li><a href="../modules/routes.organization.companies.html">routes.organization.companies</a></li>
                                <li><a href="../modules/routes.organization.teams.html">routes.organization.teams</a></li>
                                <li><a href="../modules/routes.organization.users.html">routes.organization.users</a></li>
                                <li><a href="../modules/routes.payments.html">routes.payments</a></li>
                                <li><a href="../modules/routes.reports.finance.accounts.html">routes.reports.finance.accounts</a></li>
                                <li><a href="../modules/routes.reports.finance.billings.html">routes.reports.finance.billings</a></li>
                                <li><a href="../modules/routes.reports.finance.earnings.html">routes.reports.finance.earnings</a></li>
                                <li><a href="../modules/routes.reports.time.html">routes.reports.time</a></li>
                                <li><a href="../modules/routes.snapshot.html">routes.snapshot</a></li>
                                <li><a href="../modules/routes.teams.html">routes.teams</a></li>
                                <li><a href="../modules/routes.workdays.html">routes.workdays</a></li>
                                <li><a href="../modules/routes.workdiary.html">routes.workdiary</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: lib/client.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Upwork auth library for using with public API by OAuth2
 *
 * @package     UpworkAPI
 * @since       02/10/2018
 * @copyright   Copyright 2018(c) Upwork.com
 * @author      Maksym Novozhylov &lt;mnovozhilov@upwork.com&gt;
 * @license     Upwork&#x27;s API Terms of Use {@link https://developers.upwork.com/api-tos.html}
 */

/**
 * @module client
 * @requires simple-oauth2
 */

debug(&#x27;export client module&#x27;);

const request = require(&#x27;request&#x27;);
const { ClientCredentials, AuthorizationCode } = require(&#x27;simple-oauth2&#x27;);

const UpworkLibraryUserAgent = &#x27;Github Upwork API NodeJS Client&#x27;;

/**
 * @class Client
 * @constructor
 */
function Client(config) {
  debug(&#x27;starting client&#x27;)
  debug(config.clientId, &#x27;with client id&#x27;);
  debug(config.clientSecret, &#x27;with client secret&#x27;);
  debug(config.state, &#x27;with state&#x27;);

  this.config = config;
  this.baseUrl = config.baseUrl;
  this.entryPoint = undefined;
  this.tenantId = undefined;
  
  var oauth2Config = {
    client: {
      id: config.clientId,
      secret: config.clientSecret
    },
    auth: {
      tokenHost: config.tokenHost,
      tokenPath: config.tokenPath,
    },
    http: {
      headers: {
        &#x27;User-Agent&#x27;: UpworkLibraryUserAgent
      },
    }
  };

  if (this.config.grantType === &#x27;client_credentials&#x27;) {
    this.simpleOauth2Client = new ClientCredentials(oauth2Config);
  } else {
    oauth2Config.auth[&#x27;authorizePath&#x27;] = config.authorizePath;
    this.simpleOauth2Client = new AuthorizationCode(oauth2Config);
  }

  debug(this.simpleOauth2Client, &#x27;got an oauth2 client&#x27;);
}

/**
 * Get authorization URL and request token
 *
 * @method getAuthorizationUrl
 */
Client.prototype.getAuthorizationUrl = function() {
  debug(this.config.redirectUri, &#x27;get authorization url with the specific request uri&#x27;);
  
  return this.simpleOauth2Client.authorizeURL({
    redirect_uri: this.config.redirectUri,
    state: this.config.state 
  });
}

/**
 * Get access/refresh tokens pair
 *
 * @method getToken
 * @param authzCode {String} Authorization code
 * @param callback
 */
Client.prototype.getToken = async function(authzCode, callback) {
  var accessToken;
  var error;

  try {
    if (this.config.grantType == &#x27;client_credentials&#x27;) {
      accessToken = await this.simpleOauth2Client.getToken();
    } else {
      accessToken = await this.simpleOauth2Client.getToken({
        code: authzCode,
        redirect_uri: this.config.redirectUri
      });
    }
    debug(accessToken, &#x27;Received an access token&#x27;);
  } catch (error) {
    debug(error.message, &#x27;Can not get valid Access Token&#x27;);
    debug(error, &#x27;Error&#x27;);
  }

  callback(error, accessToken);
}

/**
 * Set new access/refresh token pair
 *
 * @method setAccessToken
 * @param tokenPair
 * @param callback
 * @async
 */
Client.prototype.setNewAccessTokenPair = function (tokenPair, callback) {
  debug(tokenPair, &#x27;setting access token from token pair&#x27;);
  let aToken = this.simpleOauth2Client.createToken(tokenPair.token);

  this.config.accessToken = aToken.token.access_token;
  this.config.refreshToken = aToken.token.refresh_token;
  callback(aToken.token);
}

/**
 * Set known access/refresh token pair
 * 
 * @method setAccessToken
 * @param callback
 * @async
 */
Client.prototype.setAccessToken = function(callback) {
  debug(&#x27;setting access token from config&#x27;);
  let aToken = this.simpleOauth2Client.createToken({
      access_token: this.config.accessToken,
      refresh_token: this.config.refreshToken,
      expires_in: this.config.expiresIn,
      expires_at: this.config.expiresAt
  });

  if (aToken.expired()) {
    debug(&#x27;the access token has expired, refreshing&#x27;);
    aToken.refresh((error, result) =&gt; {
      aToken = result;
      debug(aToken, &#x27;received a new AccessToken object&#x27;);
      this.config.accessToken = aToken.token.access_token;
      callback(aToken.token);
    });
  } else {
    callback(aToken.token);
  }
}

/**
 * Specify entry point used in base url
 *
 * @method setEntryPoint
 * @param entryPoint {String} Entry point, e.g. &#x27;api&#x27; or &#x27;gds&#x27;
 */
Client.prototype.setEntryPoint = function(entryPoint) {
  debug(&#x27;updating entry point&#x27;);
  this.entryPoint = entryPoint;
  // a trick to support different entry points in node-upwork
  if (entryPoint === &#x27;graphql&#x27;) {
    this.baseUrl = this.config.gqlUrl;
  } else {
    this.baseUrl = this.baseUrl.replace(/\/api\//i, &#x27;/&#x27; + entryPoint + &#x27;/&#x27;);
  }
}

/**
 * Configure X-Upwork-API-TenantId header
 *
 * @method setOrgUidHeader
 * @param tenantId {String} Organization UID
 * @param callback
 * @async
 */
Client.prototype.setOrgUidHeader = function(tenantId, callback) {
  debug(&#x27;setting organization uid header&#x27;);
  this.tenantId = tenantId;
}

/**
 * Send GET request
 *
 * @method get
 * @param url {String} Relative URL
 * @param params {Hash} Parameters
 * @param callback
 * @async
 */
Client.prototype.get = function(url, params, callback) {
  debug(&#x27;running GET request&#x27;);
  this.sendRequest(&#x27;GET&#x27;, url, params, callback);
}

/**
 * Send POST request
 *
 * @method post
 * @param url {String} Relative URL
 * @param params {Hash} Parameters
 * @param callback
 * @async
 */
Client.prototype.post = function(url, params, callback) {
  debug(&#x27;running POST request&#x27;);
  this.sendRequest(&#x27;POST&#x27;, url, params, callback);
}

/**
 * Send PUT request
 *
 * @method get
 * @param url {String} Relative URL
 * @param params {Hash} Parameters
 * @param callback
 * @async
 */
Client.prototype.put = function(url, params, callback) {
  debug(&#x27;running PUT request&#x27;);
  this.sendRequest(&#x27;PUT&#x27;, url, params, callback);
}

/**
 * Send DELETE request
 *
 * @method delete
 * @param url {String} Relative URL
 * @param params {Hash} Parameters
 * @param callback
 * @async
 */
Client.prototype.delete = function(url, params, callback) {
  debug(&#x27;running DELETE request&#x27;);
  this.sendRequest(&#x27;DELETE&#x27;, url, params, callback);
}

/**
 * Send request
 *
 * @method sendRequest
 * @param method {String} HTTP method
 * @param url {String} Relative URL
 * @param params {Hash} Parameters
 * @param callback
 * @async
 */
Client.prototype.sendRequest = function (method, url, params, callback) {
  debug(&#x27;sending request&#x27;);

  var _params;
  switch (method) {
    case &#x27;GET&#x27;:
      _params = {qs: params};
      break;
    case &#x27;POST&#x27;:
      if (this.entryPoint !== &#x27;graphql&#x27;) {
        _params = {formData: params};
      }
      break;
    default:
      _params = {formData: Object.assign(params, {http_method: method.toLowerCase()})};
      method = &#x27;POST&#x27;;
  }

  var _options = {
    method: method,
    url: this.baseUrl + url + ((this.entryPoint === undefined || this.entryPoint == &#x27;api&#x27;) ? &#x27;.json&#x27; : &#x27;&#x27;),
    auth: {
      bearer: this.config.accessToken
    },
    headers: {
      &#x27;User-Agent&#x27;: UpworkLibraryUserAgent
    }
  };
  // GraphQL support
  if (this.entryPoint === &#x27;graphql&#x27;) {
    if (this.tenantId !== undefined) {
      _options.headers[&#x27;X-Upwork-API-TenantId&#x27;] = this.tenantId;
    }
    _options.headers[&#x27;Content-Type&#x27;] = &#x27;application/json&#x27;;
    _options.body = JSON.stringify(params);
  }

  debug(_options, &#x27;Options for request&#x27;);
  debug(_params, &#x27;Params for request&#x27;);

  request(Object.assign(_options, _params), (err, httpResponse, body) =&gt; {
    if (err) {
      debug(err, &#x27;Request error&#x27;);
      debug(httpResponse, &#x27;httpResponse&#x27;);
      debug(body, &#x27;Body&#x27;);
    }
    callback(err, httpResponse.statusCode, parseResponse(body));
  });
}

/**
 * Parse response body
 *
 * @method parseResponse
 * @param body {String} Response body
 */
function parseResponse(body) {
  try {
    return JSON.parse(body);
  } catch (e) {
    return {};
  }
}

module.exports = Client;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
